# Архитектура кода робота

## Обзор

Код был рефакторен согласно принципам **SOLID**, **KISS** и **DRY**. Монолитный файл `main.cpp` (687 строк) разделен на логические модули.

## Структура модулей

### 1. Config.h (76 строк)
**Назначение:** Централизованная конфигурация
- Все константы и настройки в одном месте
- Определения пинов GPIO
- Параметры робота (колеса, энкодеры)
- Параметры ПИД и скорости

**Принципы:**
- **Single Responsibility:** Только конфигурация
- **KISS:** Простые define константы

### 2. Sensors (130 строк: .h + .cpp)
**Назначение:** Работа с датчиками линии
- Чтение значений с 5 датчиков TCRT5000
- Вычисление позиции линии (взвешенный метод)
- Калибровка датчиков

**Класс:** `LineSensors`

**Методы:**
```cpp
void begin()                        // Инициализация
void read(int sensors[5])           // Чтение датчиков
float calculatePosition(int[5])     // Позиция линии
void calibrate()                    // Калибровка
```

**Принципы:**
- **Single Responsibility:** Только датчики
- **Encapsulation:** Данные калибровки скрыты
- **DRY:** Логика позиции в одном месте

### 3. Motors (97 строк: .h + .cpp)
**Назначение:** Управление моторами L298N
- Установка скорости левого/правого мотора
- Базовые движения (вперед, назад, повороты)
- Остановка моторов

**Класс:** `Motors`

**Методы:**
```cpp
void begin()                         // Инициализация
void setSpeed(int left, int right)   // Установка скорости
void stop()                          // Остановка
void moveForward(int speed)          // Вперед
void moveBackward(int speed)         // Назад
void turnLeft(int speed)             // Поворот влево
void turnRight(int speed)            // Поворот вправо
```

**Принципы:**
- **Single Responsibility:** Только моторы
- **KISS:** Простой интерфейс
- **DRY:** Общая логика в setSpeed()

### 4. PIDController (74 строки: .h + .cpp)
**Назначение:** ПИД-регулятор для следования по линии
- Вычисление корректировки на основе ошибки
- Поддержка всех трех компонент (P, I, D)
- Защита от integral windup

**Класс:** `PIDController`

**Методы:**
```cpp
float calculate(float error)           // Вычислить корректировку
void reset()                           // Сброс состояния
void setGains(float p, float i, float d) // Установить коэффициенты
void getGains(float &p, &i, &d)        // Получить коэффициенты
```

**Принципы:**
- **Single Responsibility:** Только ПИД алгоритм
- **Open/Closed:** Можно расширять без изменений
- **Encapsulation:** Внутреннее состояние скрыто

### 5. Encoders (125 строк: .h + .cpp)
**Назначение:** Работа с оптическими энкодерами FC-03
- Подсчет импульсов через прерывания
- Вычисление скорости колес
- Потокобезопасный доступ к счетчикам

**Класс:** `Encoders`

**Методы:**
```cpp
void begin()                   // Инициализация
void update()                  // Обновление скоростей
float getLeftSpeed()           // Скорость левого колеса
float getRightSpeed()          // Скорость правого колеса
long getLeftTicks()            // Количество тиков левого
long getRightTicks()           // Количество тиков правого
void resetTicks()              // Сброс счетчиков
```

**Принципы:**
- **Single Responsibility:** Только энкодеры
- **Encapsulation:** Прерывания и мьютексы скрыты
- **Dependency Inversion:** Работает через интерфейс

### 6. LineFollower (245 строк: .h + .cpp)
**Назначение:** Координация всех компонентов
- Управление состояниями робота
- Алгоритм следования по линии
- Алгоритм поиска линии
- Обработка команд

**Класс:** `LineFollower`

**Состояния:** `IDLE`, `FOLLOWING`, `SEARCHING_LEFT`, `SEARCHING_RIGHT`, `LOST`, `STOPPED`, `CALIBRATING`

**Методы:**
```cpp
void begin()            // Инициализация всех компонентов
void update()           // Обновление состояния
void start()            // Начать следование
void pause()            // Пауза
void stop()             // Остановка
void calibrate()        // Калибровка
void increaseSpeed()    // Увеличить скорость
void decreaseSpeed()    // Уменьшить скорость
```

**Принципы:**
- **Single Responsibility:** Координация компонентов
- **Dependency Injection:** Принимает зависимости через конструктор
- **Open/Closed:** Легко добавить новые состояния

### 7. main.cpp (161 строка)
**Назначение:** Точка входа программы
- Создание объектов
- Функции `setup()` и `loop()`
- Обработка Serial команд
- Вывод справки

**Принципы:**
- **KISS:** Минимальная логика
- **DRY:** Вся бизнес-логика в модулях

## Сравнение

| Параметр | Было | Стало |
|----------|------|-------|
| Файлов | 1 | 13 (6 пар .h/.cpp + main.cpp) |
| Строк в main.cpp | 687 | 161 |
| Классов | 0 | 6 |
| Повторяющийся код | Да | Нет |

## Преимущества новой архитектуры

### 1. SOLID принципы

✅ **Single Responsibility** - каждый класс делает одну вещь:
- `LineSensors` - только датчики
- `Motors` - только моторы
- `PIDController` - только ПИД
- `Encoders` - только энкодеры
- `LineFollower` - координация

✅ **Open/Closed** - легко расширять без изменений:
- Добавить новый тип датчика - создать новый класс
- Изменить алгоритм ПИД - изменить только PIDController

✅ **Liskov Substitution** - можно подменять реализации

✅ **Interface Segregation** - узкие интерфейсы

✅ **Dependency Inversion** - зависимости через конструктор

### 2. KISS принцип

✅ Каждый модуль прост и понятен
✅ Четкое разделение ответственности
✅ Простые интерфейсы

### 3. DRY принцип

✅ Код управления моторами в одном месте
✅ ПИД алгоритм не дублируется
✅ Логика датчиков централизована

### 4. Практические преимущества

✅ **Легко тестировать** - каждый модуль независим
✅ **Легко поддерживать** - изменения локализованы
✅ **Легко расширять** - добавлять новые функции
✅ **Легко читать** - код структурирован
✅ **Легко отлаживать** - проблемы изолированы

## Использование

### Компиляция
```bash
pio run
```

### Загрузка
```bash
pio run --target upload
```

### Мониторинг
```bash
pio device monitor
```

## Зависимости между модулями

```
main.cpp
  ├── Config.h
  ├── LineFollower (.h/.cpp)
  │   ├── Sensors (.h/.cpp)
  │   │   └── Config.h
  │   ├── Motors (.h/.cpp)
  │   │   └── Config.h
  │   ├── PIDController (.h/.cpp)
  │   │   └── Config.h
  │   └── Encoders (.h/.cpp) [опционально]
  │       └── Config.h
  └── Arduino.h
```

## Расширение функциональности

### Добавить новый тип датчика
1. Создать класс наследник от базового интерфейса
2. Реализовать методы `read()` и `calculatePosition()`
3. Заменить в `main.cpp`

### Добавить новое состояние робота
1. Добавить в `enum RobotState`
2. Добавить обработку в `LineFollower::update()`
3. Добавить команду в `handleSerialCommands()`

### Изменить алгоритм ПИД
1. Изменить только `PIDController::calculate()`
2. Остальной код не меняется

## Заключение

Рефакторинг позволил:
- ✅ Уменьшить main.cpp с 687 до 161 строки (76% сокращение)
- ✅ Разделить код на 6 логических модулей
- ✅ Применить принципы SOLID, KISS, DRY
- ✅ Упростить поддержку и расширение
- ✅ Удалить неиспользуемый файл main_camera_backup.cpp
