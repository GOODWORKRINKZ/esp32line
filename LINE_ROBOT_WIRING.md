# Схема подключения робота следующего по линии

## Компоненты

1. **ESP32 DevKit** (30 GPIO пинов)
2. **5× TCRT5000** - датчики линии (цифровые выходы)
3. **2× FC-03** - оптические энкодеры (опционально)
4. **L298N** - драйвер моторов (с припаянными Enable)
5. **2× DC моторы с редуктором** (6-12V)
6. **Батарея** - 7.4V Li-Po 2S или 9V (для L298N и моторов)
7. **Стабилизатор** - опционально (можно использовать 5V выход L298N для ESP32)

## Распиновка ESP32 DevKit для проекта

### Датчики линии TCRT5000 (цифровые входы)
```
TCRT5000 #1 (крайний левый)  → GPIO 32
TCRT5000 #2 (левый)          → GPIO 33
TCRT5000 #3 (центральный)    → GPIO 25
TCRT5000 #4 (правый)         → GPIO 26
TCRT5000 #5 (крайний правый) → GPIO 27
```

**Обоснование выбора пинов:**
- GPIO 32, 33, 25, 26, 27 - поддерживают цифровой вход
- Расположены рядом на плате - удобная разводка
- Не конфликтуют с UART, SPI, I2C

### Управление моторами L298N
```
L298N IN1 (левый мотор +)  → GPIO 12
L298N IN2 (левый мотор -)  → GPIO 13
L298N IN3 (правый мотор +) → GPIO 14
L298N IN4 (правый мотор -) → GPIO 15
```

**Примечание:** L298N ENA и ENB припаяны к HIGH → моторы всегда включены, управление через IN1-IN4

### Энкодеры FC-03 (опционально, прерывания)
```
FC-03 левый  (OUT) → GPIO 16 (RX2) - поддерживает прерывания
FC-03 правый (OUT) → GPIO 17 (TX2) - поддерживает прерывания
```

**Обоснование:**
- GPIO 16, 17 поддерживают внешние прерывания (IRAM_ATTR)
- Высокая скорость обработки импульсов
- Не конфликтуют с основным UART0 (Serial)

### Питание
```
Батарея 7.4V → L298N (12V вход)
L298N 5V OUT → ESP32 VIN (или 5V пин)
GND общий    → ESP32 GND, L298N GND, датчики GND
```

## Детальные схемы подключения

### 1. Подключение TCRT5000

Каждый датчик TCRT5000 (без подстроечного резистора, цифровой выход):

```
TCRT5000          ESP32
───────────────────────
VCC (3.3-5V) →   3.3V
GND          →   GND
OUT (D0)     →   GPIO (32/33/25/26/27)
```

**Логика работы:**
- OUT = LOW (0) → датчик видит черную линию (отражения нет)
- OUT = HIGH (1) → датчик видит белое поле (есть отражение)

**Схема:**
```
     ESP32
      │
   3.3V│    GND
      │     │
      ▼     ▼
   ┌──────────┐
   │ TCRT5000 │
   │  VCC GND │
   │   OUT    │
   └────┬─────┘
        │
        ▼
    GPIO 32/33/25/26/27
```

### 2. Подключение L298N

```
L298N                 ESP32/Питание
──────────────────────────────────────
12V (или 7-12V)  ←   Батарея +
GND              ←   Батарея - (общий GND)
5V OUT           →   ESP32 VIN (питание для ESP32)

IN1              ←   GPIO 12
IN2              ←   GPIO 13
IN3              ←   GPIO 14
IN4              ←   GPIO 15

OUT1             →   Левый мотор +
OUT2             →   Левый мотор -
OUT3             →   Правый мотор +
OUT4             →   Правый мотор -

ENA              →   Припаян к 5V (HIGH) - всегда включен
ENB              →   Припаян к 5V (HIGH) - всегда включен
```

**Управление моторами:**

| Режим            | IN1 | IN2 | Результат (OUT1-OUT2) |
|------------------|-----|-----|-----------------------|
| Вперед           | 1   | 0   | Мотор вращается вперед|
| Назад            | 0   | 1   | Мотор вращается назад |
| Стоп (тормоз)    | 1   | 1   | Короткое замыкание    |
| Свободный ход    | 0   | 0   | Отключен              |

**Для ШИМ-управления скоростью (без ENA/ENB):**
```cpp
// Скорость через PWM на IN1/IN2
// Направление: вперед, скорость 70%
analogWrite(IN1, 179);  // 70% от 255
digitalWrite(IN2, LOW);

// Скорость 50%
analogWrite(IN1, 128);  // 50% от 255
digitalWrite(IN2, LOW);
```

### 3. Подключение FC-03 (энкодеры)

```
FC-03 левый          ESP32
────────────────────────────
VCC (3.3-5V)    →   3.3V
GND             →   GND
OUT             →   GPIO 16

FC-03 правый         ESP32
────────────────────────────
VCC (3.3-5V)    →   3.3V
GND             →   GND
OUT             →   GPIO 17
```

**Механическая установка:**
- Прорезной диск FC-03 устанавливается на вал мотора
- Датчик крепится неподвижно возле диска
- Зазор между диском и датчиком: 1-3 мм

**Выходной сигнал:**
```
      ┌──┐    ┌──┐    ┌──┐
HIGH  │  │    │  │    │  │
      │  └────┘  └────┘  └────
LOW   
      ^  ^    ^  ^    ^  ^
      └──┴────┴──┴────┴──┘
      Прорези в диске
      
Каждый переход LOW→HIGH = 1 импульс
```

## Полная схема подключения

```
                         ESP32 DevKit
                    ┌────────────────────┐
                    │                    │
  Датчики линии:    │ GPIO32 ←TCRT #1    │
  ┌─────────┐       │ GPIO33 ←TCRT #2    │
  │ TCRT #1 │───────┤ GPIO25 ←TCRT #3    │
  │ TCRT #2 │───────┤ GPIO26 ←TCRT #4    │
  │ TCRT #3 │───────┤ GPIO27 ←TCRT #5    │
  │ TCRT #4 │───────┤                    │
  │ TCRT #5 │───────┤ GPIO12 →IN1        │
  └─────────┘       │ GPIO13 →IN2        │
                    │ GPIO14 →IN3        │
  Энкодеры:         │ GPIO15 →IN4        │
  ┌─────────┐       │                    │
  │ FC-03 L │───────┤ GPIO16 ←Enc Left   │
  │ FC-03 R │───────┤ GPIO17 ←Enc Right  │
  └─────────┘       │                    │
                    │ VIN ←5V (от L298N) │
                    │ GND                │
                    └────────┬───────────┘
                             │
                             │ GND (общий)
                             │
                    ┌────────┴───────────┐
                    │      L298N         │
                    │                    │
        Батарея     │  12V  GND  5V(out) │
       7.4V Li-Po   │  ↑    ↑    ↓       │
          ┌─┴─┐     │  │    │    └→ESP32 │
          │ + │─────┤  │    │            │
          │ - │─────┤  │    └→GND общий  │
          └───┘     │  └→Питание         │
                    │                    │
      Моторы:       │  OUT1 OUT2         │
      ┌──────┐      │   ↓    ↓           │
      │Левый │←─────┤   Мотор Левый      │
      │      │      │                    │
      │Правый│←─────┤  OUT3 OUT4         │
      └──────┘      │   ↓    ↓           │
                    │   Мотор Правый     │
                    │                    │
                    │  ENA ENB (паяны)   │
                    └────────────────────┘
```

## Таблица GPIO ESP32 (итоговая)

| GPIO | Функция              | Устройство           | Тип     |
|------|----------------------|----------------------|---------|
| 32   | Датчик линии #1      | TCRT5000 крайний лев | INPUT   |
| 33   | Датчик линии #2      | TCRT5000 левый       | INPUT   |
| 25   | Датчик линии #3      | TCRT5000 центр       | INPUT   |
| 26   | Датчик линии #4      | TCRT5000 правый      | INPUT   |
| 27   | Датчик линии #5      | TCRT5000 крайний прав| INPUT   |
| 12   | Мотор лев вперед     | L298N IN1            | OUTPUT  |
| 13   | Мотор лев назад      | L298N IN2            | OUTPUT  |
| 14   | Мотор прав вперед    | L298N IN3            | OUTPUT  |
| 15   | Мотор прав назад     | L298N IN4            | OUTPUT  |
| 16   | Энкодер левый        | FC-03 OUT            | INPUT   |
| 17   | Энкодер правый       | FC-03 OUT            | INPUT   |

## Рекомендации по монтажу

### 1. Общий GND
**КРИТИЧЕСКИ ВАЖНО:** Все устройства должны иметь общий GND:
- ESP32 GND
- L298N GND
- Батарея минус
- Все датчики TCRT5000 GND
- Оба энкодера FC-03 GND

### 2. Питание ESP32
**Варианты:**
- **Рекомендуется:** От 5V выхода L298N → ESP32 VIN
- **Альтернатива:** Отдельный стабилизатор 5V от батареи → ESP32 VIN
- **НЕ напрямую:** Батарею 7.4V НЕЛЬЗЯ подавать на ESP32 без стабилизатора!

### 3. Питание датчиков
- **TCRT5000:** можно питать от 3.3V ESP32 (малый ток потребления)
- **FC-03:** можно питать от 3.3V ESP32 (малый ток потребления)

### 4. Защита от помех
```
Рекомендуется установить:
1. Конденсаторы 100nF на VCC каждого датчика (близко к датчику)
2. Конденсатор 1000µF на входе L298N (стабилизация питания)
3. Диоды обратного тока на моторах (защита L298N)
```

### 5. Проводка
- Используйте короткие провода для питания (толщина 0.5-0.75мм²)
- Сигнальные провода датчиков - витая пара или экранированные
- Разделяйте силовые и сигнальные провода

## Тестирование подключения

### Шаг 1: Проверка датчиков TCRT5000
```cpp
void setup() {
    Serial.begin(115200);
    pinMode(32, INPUT);
    pinMode(33, INPUT);
    pinMode(25, INPUT);
    pinMode(26, INPUT);
    pinMode(27, INPUT);
}

void loop() {
    Serial.print(digitalRead(32)); Serial.print(" ");
    Serial.print(digitalRead(33)); Serial.print(" ");
    Serial.print(digitalRead(25)); Serial.print(" ");
    Serial.print(digitalRead(26)); Serial.print(" ");
    Serial.println(digitalRead(27));
    delay(200);
}
// Ожидаем: 1 1 1 1 1 на белом поле
//          0 в том датчике, который над линией
```

### Шаг 2: Проверка моторов
```cpp
void setup() {
    pinMode(12, OUTPUT);
    pinMode(13, OUTPUT);
    pinMode(14, OUTPUT);
    pinMode(15, OUTPUT);
}

void loop() {
    // Оба вперед 2 сек
    digitalWrite(12, HIGH); digitalWrite(13, LOW);
    digitalWrite(14, HIGH); digitalWrite(15, LOW);
    delay(2000);
    
    // Стоп 1 сек
    digitalWrite(12, LOW); digitalWrite(13, LOW);
    digitalWrite(14, LOW); digitalWrite(15, LOW);
    delay(1000);
}
// Ожидаем: оба мотора крутятся вперед 2 сек, затем стоп
```

### Шаг 3: Проверка энкодеров
```cpp
volatile int leftCount = 0;

void IRAM_ATTR leftISR() {
    leftCount++;
}

void setup() {
    Serial.begin(115200);
    pinMode(16, INPUT);
    attachInterrupt(16, leftISR, RISING);
}

void loop() {
    Serial.println(leftCount);
    delay(500);
}
// Покрутите колесо рукой - счетчик должен расти
```

## Безопасность

⚠️ **ВАЖНО:**

1. **Первое включение:** Отключите моторы от L298N
2. **Проверка полярности:** Перепутанная полярность убьет ESP32
3. **Ток моторов:** Убедитесь что L298N выдерживает ток ваших моторов (обычно до 2A на канал)
4. **Перегрев:** L298N может сильно греться - предусмотрите радиатор
5. **Короткое замыкание:** Проверьте все соединения тестером перед подачей питания

## Что дальше?

После подключения переходите к файлу с кодом:
- `line_robot_main.ino` - основная прошивка
- Калибровка датчиков
- Настройка ПИД-коэффициентов
- Тестирование на трассе
